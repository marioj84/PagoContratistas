<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago Contratistas</title>
    <style>
        /* Estilos similares */
    </style>
</head>
<body>
    <img id="logo" src="https://d31n4s42c9zm35.cloudfront.net/cl/uploads/2023/10/logo-lipigas.svg" alt="Logo Empresa">
    <h2>Ingreso de Órdenes de Trabajo (OT)</h2>
    
    <p>Esta herramienta permite a los contratistas ingresar sus órdenes de trabajo (OT) mensualmente. 
       Cada OT debe incluir la descripción del trabajo realizado y el monto a cobrar. 
       Al finalizar, se generará un resumen de los valores ingresados y un archivo con el detalle completo.</p>

    <div id="error-msg">Por favor, complete todos los campos correctamente.</div>

    <table id="otTable" aria-label="Tabla de Órdenes de Trabajo">
        <tr>
            <th class="col-ot">OT</th>
            <th>Tipo de OT</th>
            <th>Cant</th>
            <th class="col-descripcion">Descripción</th>
            <th class="col-monto">Monto</th>
            <th class="col-subtotal">Subtotal</th>
            <th>Acciones</th>
        </tr>
    </table>

    <div style="text-align: center;">
        <button id="summaryBtn" class="burdeo hidden" onclick="viewSummary()">Ver Resumen</button>
        <button onclick="addRow()" class="verde">Agregar OT</button>
    </div>

    <div style="text-align: center;">
        <button id="finalizeBtn" class="burdeo hidden" onclick="finalizeAndDownload()">Validar y Descargar Soporte</button>
        <button id="clearBtn" class="verde hidden" onclick="clearTable()">Limpiar Tabla</button>
    </div>

    <footer>
        Para cualquier duda o consulta, por favor contactar a Mario Jaimes a través del correo: 
        <a href="mailto:mjaimes@lipigas.cl">mjaimes@lipigas.cl</a>.
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script>
        let otData = [];

        // Función para agregar una fila de OT
        function addRow() {
            const table = document.getElementById('otTable');
            const row = table.insertRow();
            const otCell = row.insertCell(0);
            const tipoCell = row.insertCell(1);
            const cantCell = row.insertCell(2);
            const descCell = row.insertCell(3);
            const montoCell = row.insertCell(4);
            const subtotalCell = row.insertCell(5);
            const actionsCell = row.insertCell(6);

            const inputOT = document.createElement('input');
            inputOT.type = 'number';
            inputOT.step = "1";  
            inputOT.min = "1";
            inputOT.ariaLabel = 'Ingresar OT';
            otCell.appendChild(inputOT);

            const selectTipo = document.createElement('select');
            const trabajosList = ["Instalación", "Mantenimiento", "Reparación"];
            trabajosList.forEach(trabajo => {
                const optionElement = document.createElement('option');
                optionElement.value = trabajo;
                optionElement.text = trabajo;
                selectTipo.appendChild(optionElement);
            });
            selectTipo.ariaLabel = 'Seleccionar Tipo de OT';
            tipoCell.appendChild(selectTipo);

            const inputCant = document.createElement('input');
            inputCant.type = 'number';
            inputCant.min = "1";
            inputCant.value = "1";
            inputCant.ariaLabel = 'Ingresar Cantidad';
            cantCell.appendChild(inputCant);

            const inputDesc = document.createElement('input');
            inputDesc.type = 'text';
            inputDesc.ariaLabel = 'Ingresar Descripción';
            descCell.appendChild(inputDesc);

            const inputMonto = document.createElement('input');
            inputMonto.type = 'number';
            inputMonto.placeholder = '$0.00';
            inputMonto.step = "0.01";
            inputMonto.min = "0";
            inputMonto.ariaLabel = 'Ingresar Monto';
            montoCell.appendChild(inputMonto);

            const inputSubtotal = document.createElement('input');
            inputSubtotal.type = 'text';
            inputSubtotal.placeholder = '$0.00';
            inputSubtotal.disabled = true;
            inputSubtotal.ariaLabel = 'Subtotal';
            subtotalCell.appendChild(inputSubtotal);

            // Calcular subtotal al cambiar cantidad o monto
            inputCant.oninput = function() {
                const cantidad = inputCant.value;
                const monto = inputMonto.value;
                inputSubtotal.value = (cantidad * monto).toFixed(2);
            };
            inputMonto.oninput = function() {
                const cantidad = inputCant.value;
                const monto = inputMonto.value;
                inputSubtotal.value = (cantidad * monto).toFixed(2);
            };

            const deleteButton = document.createElement('button');
            deleteButton.innerText = 'Eliminar OT';
            deleteButton.className = 'acciones-btn burdeo';
            deleteButton.style.whiteSpace = "nowrap";
            deleteButton.onclick = () => deleteRow(row);
            actionsCell.appendChild(deleteButton);

            document.getElementById('summaryBtn').classList.remove('hidden');
        }

        function deleteRow(row) {
            row.remove(); 
        }

        // Función para ver el resumen
        function viewSummary() {
            const table = document.getElementById('otTable');
            otData = [];
            let valid = true;

            for (let i = 1; i < table.rows.length; i++) {
                const row = table.rows[i];
                const ot = row.cells[0].children[0].value.trim();
                const tipo = row.cells[1].children[0].value;
                const cantidad = row.cells[2].children[0].value;
                const descripcion = row.cells[3].children[0].value.trim();
                const monto = row.cells[4].children[0].value.trim();
                const subtotal = row.cells[5].children[0].value.trim();

                if (ot === "" || descripcion === "" || monto === "") {
                    row.cells[0].children[0].classList.add('invalid-input');
                    valid = false;
                }

                if (valid) {
                    otData.push({ ot, tipo, cantidad, descripcion, monto, subtotal });
                }
            }

            if (valid) {
                document.getElementById('error-msg').style.display = "none";
                // Aquí solo se envía el OTData (solo OT)
                enviarSoloOT(otData);
                document.getElementById('finalizeBtn').classList.remove('hidden');
                document.getElementById('clearBtn').classList.remove('hidden');
            } else {
                document.getElementById('error-msg').style.display = "block";
            }
        }

        // Función para enviar solo las OT a la hoja de cálculo
        function enviarSoloOT(otData) {
            const formData = new FormData();

            otData.forEach((row, index) => {
                formData.append(`OT_${index}_ot`, row.ot);
                formData.append(`OT_${index}_tipo`, row.tipo);
                formData.append(`OT_${index}_cantidad`, row.cantidad);
                formData.append(`OT_${index}_descripcion`, row.descripcion);
                formData.append(`OT_${index}_monto`, row.monto);
                formData.append(`OT_${index}_subtotal`, row.subtotal);
            });

            fetch('https://script.google.com/macros/s/AKfycbwzId-iOv12oyEGUkPmqvbbf5lKVzFjrkGdmmKQhUxZ5yc15hMcdiZkIFpERvrlseZLPA/exec', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                console.log('Datos OT enviados:', data);
            })
            .catch(error => {
                console.error('Error al enviar datos OT:', error);
            });
        }

        window.onload = function() {
            // Cargar los trabajos (se simplifica aquí)
        };
    </script>
</body>
</html>
